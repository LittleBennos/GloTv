<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GloTv Server</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      padding: 24px;
      user-select: none;
    }
    h1 { color: #e94560; font-size: 22px; margin-bottom: 20px; }
    h2 { color: #e94560; font-size: 16px; margin: 20px 0 10px; border-bottom: 1px solid #333; padding-bottom: 6px; }

    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    label { font-size: 13px; color: #aaa; min-width: 120px; }
    input[type="text"], input[type="number"] {
      background: #16213e;
      border: 1px solid #333;
      color: #e0e0e0;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    input[type="text"] { flex: 1; }
    input[type="number"] { width: 70px; }

    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 7px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover { background: #c73e54; }
    button.secondary { background: #333; }
    button.secondary:hover { background: #444; }
    button.small { padding: 3px 8px; font-size: 11px; }

    .save-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #16213e;
      border-top: 1px solid #333;
      padding: 12px 24px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    #file-list { margin-bottom: 80px; }

    .file-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #16213e;
      border-radius: 6px;
      margin-bottom: 4px;
    }
    .file-row.inactive { opacity: 0.5; }
    .file-name { flex: 1; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-duration { width: 60px; }

    .toggle {
      position: relative;
      width: 36px;
      height: 20px;
      cursor: pointer;
    }
    .toggle input { display: none; }
    .toggle .slider {
      position: absolute;
      inset: 0;
      background: #333;
      border-radius: 10px;
      transition: background 0.2s;
    }
    .toggle .slider::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      left: 2px;
      top: 2px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle input:checked + .slider { background: #e94560; }
    .toggle input:checked + .slider::before { transform: translateX(16px); }

    .status-msg {
      position: fixed;
      top: 10px;
      right: 24px;
      background: #0f3460;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 13px;
      display: none;
    }
    .status-msg.show { display: block; }

    .empty-state {
      text-align: center;
      color: #555;
      padding: 40px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“º GloTv Server</h1>
  <div id="status-msg" class="status-msg"></div>

  <h2>Shared Folder</h2>
  <div class="row">
    <input type="text" id="folder-path" placeholder="Select shared drive folder..." readonly>
    <button onclick="browseFolder()">Browse...</button>
    <button class="secondary" onclick="refreshFiles()">Refresh</button>
  </div>

  <h2>Global Settings</h2>
  <div class="row">
    <label>Slide Duration (s)</label>
    <input type="number" id="slide-duration" min="1" max="300" value="10">
  </div>
  <div class="row">
    <label>Schedule Start</label>
    <input type="number" id="schedule-start" min="0" max="23" value="7">
    <label style="min-width:auto">End</label>
    <input type="number" id="schedule-end" min="0" max="23" value="19">
  </div>

  <h2>Files</h2>
  <div id="file-list">
    <div class="empty-state">Select a folder to see PPTX files</div>
  </div>

  <div class="save-bar">
    <button onclick="saveAll()">ðŸ’¾ Save Config</button>
  </div>

  <script>
    let slidesFolder = '';
    let files = []; // { name, active, duration, order }

    async function init() {
      const settings = await window.glotv.getSettings();
      if (settings.slidesFolder) {
        slidesFolder = settings.slidesFolder;
        document.getElementById('folder-path').value = slidesFolder;
        await loadExistingConfig();
        await refreshFiles();
      }
    }

    async function browseFolder() {
      const folder = await window.glotv.browseFolder();
      if (folder) {
        slidesFolder = folder;
        document.getElementById('folder-path').value = folder;
        await window.glotv.saveSettings({ slidesFolder: folder });
        await loadExistingConfig();
        await refreshFiles();
      }
    }

    async function loadExistingConfig() {
      if (!slidesFolder) return;
      const config = await window.glotv.loadConfig(slidesFolder);
      document.getElementById('slide-duration').value = config.slideDuration || 10;
      if (config.schedule) {
        document.getElementById('schedule-start').value = config.schedule.startHour ?? 7;
        document.getElementById('schedule-end').value = config.schedule.endHour ?? 19;
      }
      if (config.files && config.files.length > 0) {
        files = config.files.map((f, i) => ({
          name: f.name,
          active: f.active !== false,
          duration: f.duration,
          order: f.order ?? i,
        }));
        files.sort((a, b) => a.order - b.order);
      }
    }

    async function refreshFiles() {
      if (!slidesFolder) return;
      const diskFiles = await window.glotv.scanFiles(slidesFolder);
      const existing = new Map(files.map(f => [f.name.toLowerCase(), f]));

      // Add new files not in config
      for (const name of diskFiles) {
        if (!existing.has(name.toLowerCase())) {
          files.push({ name, active: true, duration: null, order: files.length });
        }
      }

      // Remove files no longer on disk
      const diskSet = new Set(diskFiles.map(f => f.toLowerCase()));
      files = files.filter(f => diskSet.has(f.name.toLowerCase()));

      // Re-order
      files.forEach((f, i) => f.order = i);
      renderFiles();
    }

    function renderFiles() {
      const container = document.getElementById('file-list');
      if (files.length === 0) {
        container.innerHTML = '<div class="empty-state">No PPTX files found</div>';
        return;
      }

      container.innerHTML = files.map((f, i) => `
        <div class="file-row ${f.active ? '' : 'inactive'}" data-index="${i}">
          <button class="small secondary" onclick="moveFile(${i}, -1)" ${i === 0 ? 'disabled' : ''}>â–²</button>
          <button class="small secondary" onclick="moveFile(${i}, 1)" ${i === files.length - 1 ? 'disabled' : ''}>â–¼</button>
          <label class="toggle">
            <input type="checkbox" ${f.active ? 'checked' : ''} onchange="toggleFile(${i}, this.checked)">
            <span class="slider"></span>
          </label>
          <span class="file-name" title="${f.name}">${f.name}</span>
          <input type="number" class="file-duration" min="1" max="300"
            placeholder="â€”"
            value="${f.duration != null ? f.duration : ''}"
            onchange="setFileDuration(${i}, this.value)"
            title="Per-file duration (seconds), blank = use global">
        </div>
      `).join('');
    }

    function moveFile(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= files.length) return;
      [files[index], files[newIndex]] = [files[newIndex], files[index]];
      files.forEach((f, i) => f.order = i);
      renderFiles();
    }

    function toggleFile(index, active) {
      files[index].active = active;
      renderFiles();
    }

    function setFileDuration(index, value) {
      files[index].duration = value ? parseInt(value) : null;
    }

    async function saveAll() {
      if (!slidesFolder) {
        showStatus('Select a folder first');
        return;
      }

      const config = {
        slideDuration: parseInt(document.getElementById('slide-duration').value) || 10,
        schedule: {
          startHour: parseInt(document.getElementById('schedule-start').value) || 7,
          endHour: parseInt(document.getElementById('schedule-end').value) || 19,
        },
        transition: 'crossfade',
        files: files.map((f, i) => ({
          name: f.name,
          active: f.active,
          duration: f.duration,
          order: i,
        })),
      };

      await window.glotv.saveConfig(slidesFolder, config);
      showStatus('Config saved âœ“');
    }

    function showStatus(msg) {
      const el = document.getElementById('status-msg');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }

    init();
  </script>
</body>
</html>
